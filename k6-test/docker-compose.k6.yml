version: "3.8"

# k6 Load Testing Stack
# - k6 for GraphQL and REST performance testing
# - Prometheus Remote Write for metrics

services:
  # k6 for GraphQL
  k6-graphql:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: k6-graphql
    environment:
      - GRAPHQL_URL=http://apollo-router:4000/
      - K6_PROMETHEUS_RW_SERVER_URL=http://prometheus:9090/api/v1/write
      - K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM=false
      - K6_VUS=${K6_VUS:-50}
      - K6_ITERATIONS=${K6_ITERATIONS:-10000}
      - K6_DURATION=${K6_DURATION:-10m}
    command:
      [
        "run",
        "--out",
        "experimental-prometheus-rw",
        "--tag",
        "testid=graphql-perf",
        "/scripts/k6-graphql.js",
      ]
    networks:
      - graphql-network
      - monitoring-network
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M

  # k6 for REST
  k6-rest:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: k6-rest
    environment:
      - REST_URL=http://nginx-gateway:80
      - K6_PROMETHEUS_RW_SERVER_URL=http://prometheus:9090/api/v1/write
      - K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM=false
      - K6_VUS=${K6_VUS:-50}
      - K6_ITERATIONS=${K6_ITERATIONS:-10000}
      - K6_DURATION=${K6_DURATION:-10m}
    command:
      [
        "run",
        "--out",
        "experimental-prometheus-rw",
        "--tag",
        "testid=rest-perf",
        "/scripts/k6-rest.js",
      ]
    networks:
      - rest-network
      - monitoring-network
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M

networks:
  graphql-network:
    external: true
    name: graphql-network
  rest-network:
    external: true
    name: rest-network
  monitoring-network:
    external: true
    name: monitoring-network
# Note:
# - Networks must exist before running k6
# - start-k6.sh will create networks if they don't exist
