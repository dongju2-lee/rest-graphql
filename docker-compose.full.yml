version: "3.8"

# Full Stack for REST vs GraphQL Performance Comparison
#
# Architecture:
# - REST: 3 services + NGINX Gateway
# - GraphQL: 3 services + Apollo Router
# - Monitoring: Prometheus + Grafana + cAdvisor
# - Load Testing: 2 Locust instances (REST & GraphQL)
#
# Total: 12 containers (~6GB RAM for 8GB system)
#
# Access Points:
# - GraphQL Gateway: http://localhost:14000
# - REST Gateway: http://localhost:24000
# - Grafana: http://localhost:33000 (admin/admin)
# - Prometheus: http://localhost:39090
# - Locust GraphQL: http://localhost:48089
# - Locust REST: http://localhost:58089

services:
  # ============================================
  # GraphQL Services (4 containers)
  # ============================================

  graphql-user-service:
    build:
      context: ./backend/graphql/services/user-service
    container_name: graphql-user-service
    networks:
      - graphql-network
    deploy:
      resources:
        limits: { cpus: "0.5", memory: 256M }
        reservations: { cpus: "0.25", memory: 128M }
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import httpx; httpx.get('http://localhost:8000/health')",
        ]
      interval: 10s
      timeout: 3s
      retries: 3

  graphql-robot-service:
    build:
      context: ./backend/graphql/services/robot-service
    container_name: graphql-robot-service
    networks:
      - graphql-network
    deploy:
      resources:
        limits: { cpus: "0.5", memory: 256M }
        reservations: { cpus: "0.25", memory: 128M }
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import httpx; httpx.get('http://localhost:8001/health')",
        ]
      interval: 10s
      timeout: 3s
      retries: 3

  graphql-site-service:
    build:
      context: ./backend/graphql/services/site-service
    container_name: graphql-site-service
    networks:
      - graphql-network
    deploy:
      resources:
        limits: { cpus: "0.3", memory: 256M }
        reservations: { cpus: "0.15", memory: 128M }
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import httpx; httpx.get('http://localhost:8002/health')",
        ]
      interval: 10s
      timeout: 3s
      retries: 3

  apollo-router:
    build:
      context: ./backend/graphql/gateway
    container_name: apollo-router
    ports:
      - "14000:4000" # GraphQL endpoint
      - "19090:9090" # Metrics
    depends_on:
      graphql-user-service: { condition: service_healthy }
      graphql-robot-service: { condition: service_healthy }
      graphql-site-service: { condition: service_healthy }
    networks:
      - graphql-network
      - monitoring-network
    deploy:
      resources:
        limits: { cpus: "0.5", memory: 512M }
        reservations: { cpus: "0.25", memory: 256M }

  # ============================================
  # REST Services (4 containers)
  # ============================================

  rest-user-service:
    build:
      context: ./backend/rest/services/user-service
    container_name: rest-user-service
    networks:
      - rest-network
    deploy:
      resources:
        limits: { cpus: "0.5", memory: 256M }
        reservations: { cpus: "0.25", memory: 128M }
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import httpx; httpx.get('http://localhost:8000/health')",
        ]
      interval: 10s
      timeout: 3s
      retries: 3

  rest-robot-service:
    build:
      context: ./backend/rest/services/robot-service
    container_name: rest-robot-service
    depends_on:
      - rest-user-service
    networks:
      - rest-network
    deploy:
      resources:
        limits: { cpus: "0.5", memory: 256M }
        reservations: { cpus: "0.25", memory: 128M }
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import httpx; httpx.get('http://localhost:8001/health')",
        ]
      interval: 10s
      timeout: 3s
      retries: 3

  rest-site-service:
    build:
      context: ./backend/rest/services/site-service
    container_name: rest-site-service
    networks:
      - rest-network
    deploy:
      resources:
        limits: { cpus: "0.3", memory: 256M }
        reservations: { cpus: "0.15", memory: 128M }
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import httpx; httpx.get('http://localhost:8002/health')",
        ]
      interval: 10s
      timeout: 3s
      retries: 3

  nginx-gateway:
    build:
      context: ./backend/rest/gateway
    container_name: nginx-gateway
    ports:
      - "24000:80"
    depends_on:
      rest-user-service: { condition: service_healthy }
      rest-robot-service: { condition: service_healthy }
      rest-site-service: { condition: service_healthy }
    networks:
      - rest-network
      - monitoring-network
    deploy:
      resources:
        limits: { cpus: "0.3", memory: 128M }
        reservations: { cpus: "0.15", memory: 64M }

  # ============================================
  # Monitoring Stack (3 containers)
  # ============================================

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: prometheus
    ports:
      - "39090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=3d"
    networks:
      - monitoring-network
      - graphql-network
      - rest-network
    deploy:
      resources:
        limits: { cpus: "0.5", memory: 512M }
        reservations: { cpus: "0.25", memory: 256M }

  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana
    ports:
      - "33000:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    networks:
      - monitoring-network
    depends_on:
      - prometheus
    deploy:
      resources:
        limits: { cpus: "0.5", memory: 512M }
        reservations: { cpus: "0.25", memory: 256M }

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: cadvisor
    ports:
      - "38080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    privileged: true
    networks:
      - monitoring-network
    deploy:
      resources:
        limits: { cpus: "0.3", memory: 256M }
        reservations: { cpus: "0.15", memory: 128M }

  # ============================================
  # Load Testing (initially stopped)
  # Start manually: docker-compose start locust-graphql
  # ============================================

  # locust-graphql:
  #   build:
  #     context: ./load-test
  #   container_name: locust-graphql
  #   ports:
  #     - "48089:8089"
  #   volumes:
  #     - ./load-test/locustfile_graphql.py:/app/locustfile.py:ro
  #   command: ["locust", "--host=http://apollo-router:4000", "--web-host=0.0.0.0"]
  #   networks:
  #     - graphql-network
  #   profiles: ["testing"]

  # locust-rest:
  #   build:
  #     context: ./load-test
  #   container_name: locust-rest
  #   ports:
  #     - "58089:8089"
  #   volumes:
  #     - ./load-test/locustfile_rest.py:/app/locustfile.py:ro
  #   command: ["locust", "--host=http://nginx-gateway:80", "--web-host=0.0.0.0"]
  #   networks:
  #     - rest-network
  #   profiles: ["testing"]

volumes:
  prometheus-data:
  grafana-data:

networks:
  graphql-network:
    name: graphql-network
    driver: bridge
  rest-network:
    name: rest-network
    driver: bridge
  monitoring-network:
    name: monitoring-network
    driver: bridge
